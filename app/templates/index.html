<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyAboabo - Abonnement Manager</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="/static/Logo_mit_Text.png" alt="MyAboabo Logo" class="logo">
            <div class="user-info">
                <span>Angemeldet als: <strong>{{ username }}</strong></span>
                <a href="/change-password" class="settings-button">Passwort ändern</a>
                <a href="/logout" class="logout-button">Abmelden</a>
            </div>
        </div>
        
        <div class="three-column-layout">
            <!-- Left Column - Products -->
            <div class="left-column">
                <div class="add-product-section">
                    <h2>Neues Produkt hinzufügen</h2>
                    <form id="previewProductForm" onsubmit="loadProductPreview(event)">
                        <input type="url" id="productUrl" name="url" placeholder="Produkt URL (Galaxus)" required>
                        <button type="submit">Vorschau laden</button>
                    </form>
                    <div id="loadingSpinner" class="loading-spinner" style="display: none;">
                        <div class="spinner"></div>
                        <p>Produktdaten werden geladen...</p>
                    </div>
                    <div id="productPreview" class="product-preview" style="display: none;">
                        <h3>Produktvorschau</h3>
                        <div class="preview-content">
                            <div class="preview-image">
                                <img id="previewImg" src="" alt="Product Image">
                            </div>
                            <div class="preview-info">
                                <h4 id="previewTitle"></h4>
                                <p class="preview-price" id="previewPrice"></p>
                                <input type="hidden" id="previewUrl" value="">
                                <input type="hidden" id="previewImageUrl" value="">
                                <input type="hidden" id="previewPriceValue" value="">
                            </div>
                        </div>
                        <div class="preview-actions">
                            <button onclick="confirmAddProduct()" class="btn-confirm">Produkt hinzufügen</button>
                            <button onclick="discardPreview()" class="btn-discard">Verwerfen</button>
                        </div>
                    </div>
                </div>

                <div class="products-section">
                    <h2>Alle Produkte (<span id="productCount">{{ all_products|length }}</span>)</h2>
                    <div class="filter-controls">
                        <input type="text" id="productSearch" placeholder="Produkte durchsuchen..." onkeyup="filterProducts()">
                        <select id="productFilter" onchange="filterProducts()">
                            <option value="all">Alle Produkte</option>
                            <option value="with-subscription">Mit Abo</option>
                            <option value="without-subscription">Ohne Abo</option>
                        </select>
                        <select id="productSort" onchange="sortProducts()">
                            <option value="">Sortieren nach...</option>
                            <option value="name-asc">Name (A-Z)</option>
                            <option value="name-desc">Name (Z-A)</option>
                            <option value="price-asc">Preis (niedrig-hoch)</option>
                            <option value="price-desc">Preis (hoch-niedrig)</option>
                            <option value="date-asc">Datum (alt-neu)</option>
                            <option value="date-desc">Datum (neu-alt)</option>
                        </select>
                    </div>
                    <div class="product-list" id="productList">
                        {% if all_products %}
                            {% for product in all_products %}
                            <div class="product-card {% if product.has_active_subscription %}active-indicator{% endif %}" 
                                 data-product-name="{{ product.name|lower }}" 
                                 data-has-subscription="{{ 'true' if product.has_active_subscription else 'false' }}"
                                 data-price="{{ product.price or '0' }}"
                                 data-date="{{ product.added_at.timestamp() if product.added_at else 0 }}">
                                {% if product.image_url %}
                                <div class="product-image">
                                    <img src="{{ product.image_url }}" alt="{{ product.name }}">
                                </div>
                                {% endif %}
                                <div class="product-info">
                                    <h3>
                                        {{ product.name }}
                                        {% if product.has_active_subscription %}
                                        <span class="active-badge">Im Abo</span>
                                        {% endif %}
                                    </h3>
                                    {% if product.price %}
                                    <p class="product-price">CHF {{ product.price }}</p>
                                    {% endif %}
                                    <p class="product-date">Hinzugefügt: {{ product.added_at.strftime('%d.%m.%Y %H:%M') }}</p>
                                </div>
                                <div class="product-actions">
                                    <button onclick="showSubscriptionModal({{ product.id }}, '{{ product.name }}', '{{ product.image_url or '' }}', '{{ product.price or '' }}')" class="btn-subscribe icon-btn" title="Abo erstellen">
                                        <span class="icon">➕</span>
                                        <span class="btn-text">Abo erstellen</span>
                                    </button>
                                    <button onclick="deleteProduct({{ product.id }})" class="btn-delete icon-btn" title="Löschen">
                                        <img src="/static/cross-svgrepo-com.svg" alt="Löschen" class="icon-svg">
                                        <span class="btn-text">Löschen</span>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="empty-message">Keine Produkte vorhanden</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="right-column">
                <!-- All Subscriptions -->
                <div class="all-subscriptions-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h2>Alle Abos (<span id="subscriptionCount">{{ all_subscriptions|length }}</span>)</h2>
                        <button onclick="generateEmailPreview()" class="btn-generate-email" title="Abo-E-Mail senden">
                            <svg style="width: 20px; height: 20px; margin-right: 5px;" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M4 7L10.94 11.3375C11.5885 11.7428 12.4115 11.7428 13.06 11.3375L20 7M5 18H19C20.1046 18 21 17.1046 21 16V8C21 6.89543 20.1046 6 19 6H5C3.89543 6 3 6.89543 3 8V16C3 17.1046 3.89543 18 5 18Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Abo-E-Mail senden
                        </button>
                        <!-- CART FUNCTIONALITY DEACTIVATED
                        <button onclick="addAllActiveToCart()" class="btn-add-all-cart" title="Alle aktiven Abos in Warenkorb">
                            <svg style="width: 20px; height: 20px; margin-right: 5px;" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M9 11V6C9 4.34315 10.3431 3 12 3C13.6569 3 15 4.34315 15 6V10.9673M10.4 21H13.6C15.8402 21 16.9603 21 17.816 20.564C18.5686 20.1805 19.1805 19.5686 19.564 18.816C20 17.9603 20 16.8402 20 14.6V12.2C20 11.0799 20 10.5198 19.782 10.092C19.5903 9.71569 19.2843 9.40973 18.908 9.21799C18.4802 9 17.9201 9 16.8 9H7.2C6.0799 9 5.51984 9 5.09202 9.21799C4.71569 9.40973 4.40973 9.71569 4.21799 10.092C4 10.5198 4 11.0799 4 12.2V14.6C4 16.8402 4 17.9603 4.43597 18.816C4.81947 19.5686 5.43139 20.1805 6.18404 20.564C7.03968 21 8.15979 21 10.4 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Alle Aktiven in Warenkorb
                        </button>
                        -->
                    </div>
                    <div class="filter-controls">
                        <input type="text" id="subscriptionSearch" placeholder="Abos durchsuchen..." onkeyup="filterSubscriptions()">
                        <select id="subscriptionFilter" onchange="filterSubscriptions()">
                            <option value="all">Alle Abos</option>
                            <option value="active">Nur Aktive</option>
                            <option value="inactive">Nur Inaktive</option>
                        </select>
                        <select id="subscriptionSort" onchange="sortSubscriptions()">
                            <option value="">Sortieren nach...</option>
                            <option value="name-asc">Name (A-Z)</option>
                            <option value="name-desc">Name (Z-A)</option>
                            <option value="price-asc">Preis (niedrig-hoch)</option>
                            <option value="price-desc">Preis (hoch-niedrig)</option>
                            <option value="next-buy-asc">Nächster Kauf (nah-fern)</option>
                            <option value="next-buy-desc">Nächster Kauf (fern-nah)</option>
                            <option value="date-asc">Erstellt (alt-neu)</option>
                            <option value="date-desc">Erstellt (neu-alt)</option>
                        </select>
                    </div>
                    <div class="subscription-list" id="subscriptionList">
                        {% if all_subscriptions %}
                            {% for sub in all_subscriptions %}
                            <div class="subscription-card {% if sub.is_active %}active{% endif %}" 
                                 data-subscription-name="{{ sub.product_name|lower }}" 
                                 data-is-active="{{ 'true' if sub.is_active else 'false' }}"
                                 data-next-buy="{{ sub.next_buy_date or '' }}"
                                 data-price="{{ sub.product_price or '0' }}"
                                 data-date="{{ sub.created_at.timestamp() if sub.created_at else 0 }}">
                                {% if sub.product_image %}
                                <div class="product-image">
                                    <img src="{{ sub.product_image }}" alt="{{ sub.product_name }}">
                                </div>
                                {% endif %}
                                <div class="subscription-info">
                                    <h3>
                                        {{ sub.product_name }}
                                        {% if sub.is_active %}
                                        <span class="active-badge">Aktiv</span>
                                        {% endif %}
                                    </h3>
                                    {% if sub.product_price %}
                                    <p class="product-price">CHF {{ sub.product_price }}</p>
                                    {% endif %}
                                    <p class="subscription-frequency">Frequenz: {{ sub.frequency | german_frequency }}</p>
                                    {% if sub.next_buy_date %}
                                    <p class="next-buy-date">Nächster Kauf: {{ sub.next_buy_date }}</p>
                                    {% endif %}
                                    <p class="subscription-date">Erstellt: {{ sub.created_at.strftime('%d.%m.%Y %H:%M') }}</p>
                                </div>
                                <div class="subscription-actions">
                                    <!-- CART FUNCTIONALITY DEACTIVATED
                                    <button onclick="addToCart({{ sub.id }})" class="btn-add-cart icon-btn" title="In Warenkorb">
                                        <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M9 11V6C9 4.34315 10.3431 3 12 3C13.6569 3 15 4.34315 15 6V10.9673M10.4 21H13.6C15.8402 21 16.9603 21 17.816 20.564C18.5686 20.1805 19.1805 19.5686 19.564 18.816C20 17.9603 20 16.8402 20 14.6V12.2C20 11.0799 20 10.5198 19.782 10.092C19.5903 9.71569 19.2843 9.40973 18.908 9.21799C18.4802 9 17.9201 9 16.8 9H7.2C6.0799 9 5.51984 9 5.09202 9.21799C4.71569 9.40973 4.40973 9.71569 4.21799 10.092C4 10.5198 4 11.0799 4 12.2V14.6C4 16.8402 4 17.9603 4.43597 18.816C4.81947 19.5686 5.43139 20.1805 6.18404 20.564C7.03968 21 8.15979 21 10.4 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        <span class="btn-text">Warenkorb</span>
                                    </button>
                                    -->
                                    <button onclick="editSubscription({{ sub.id }})" class="btn-edit icon-btn" title="Bearbeiten">
                                        <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M11 4H4C3.46957 4 2.96086 4.21071 2.58579 4.58579C2.21071 4.96086 2 5.46957 2 6V20C2 20.5304 2.21071 21.0391 2.58579 21.4142C2.96086 21.7893 3.46957 22 4 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V13M18.5 2.5C18.8978 2.1022 19.4374 1.87868 20 1.87868C20.5626 1.87868 21.1022 2.1022 21.5 2.5C21.8978 2.8978 22.1213 3.43739 22.1213 4C22.1213 4.56261 21.8978 5.1022 21.5 5.5L12 15L8 16L9 12L18.5 2.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        <span class="btn-text">Bearbeiten</span>
                                    </button>
                                    {% if sub.is_active %}
                                    <form method="post" action="/deactivate-subscription/{{ sub.id }}" style="display:inline">
                                        <button type="submit" class="btn-deactivate icon-btn" title="Deaktivieren">
                                            <img src="/static/pause-svgrepo-com.svg" alt="Deaktivieren" class="icon-svg">
                                            <span class="btn-text">Deaktivieren</span>
                                        </button>
                                    </form>
                                    {% else %}
                                    <form method="post" action="/activate-subscription/{{ sub.id }}" style="display:inline">
                                        <button type="submit" class="btn-activate icon-btn" title="Aktivieren">
                                            <img src="/static/play-svgrepo-com.svg" alt="Aktivieren" class="icon-svg">
                                            <span class="btn-text">Aktivieren</span>
                                        </button>
                                    </form>
                                    {% endif %}
                                    <button onclick="deleteSubscription({{ sub.id }})" class="btn-delete icon-btn" title="Löschen">
                                        <img src="/static/cross-svgrepo-com.svg" alt="Löschen" class="icon-svg">
                                        <span class="btn-text">Löschen</span>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="empty-message">Keine Abos vorhanden</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for creating subscription -->
    <div id="subscriptionModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeSubscriptionModal()">&times;</span>
            <h2>Neues Abo erstellen</h2>
            
            <div class="modal-product-info">
                <div class="modal-product-image">
                    <img id="modalProductImage" src="" alt="Product">
                </div>
                <div class="modal-product-details">
                    <h3 id="modalProductName"></h3>
                    <p class="modal-product-price" id="modalProductPrice"></p>
                </div>
            </div>
            
            <form method="post" action="/create-subscription" id="subscriptionForm">
                <input type="hidden" name="product_id" id="modalProductId">
                
                <div class="form-group">
                    <label for="start_date">Startdatum:</label>
                    <input type="date" name="start_date" id="start_date" required>
                </div>

                <div class="form-group">
                    <label for="frequency">Frequenz:</label>
                    <select name="frequency" id="frequency" required>
                        <option value="">Bitte wählen...</option>
                        <option value="täglich">Täglich</option>
                        <option value="wöchentlich">Wöchentlich</option>
                        <option value="alle 2 Wochen">Alle 2 Wochen</option>
                        <option value="monatlich">Monatlich</option>
                        <option value="alle 2 Monate">Alle 2 Monate</option>
                        <option value="vierteljährlich">Vierteljährlich</option>
                        <option value="halbjährlich">Halbjährlich</option>
                        <option value="jährlich">Jährlich</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="activate" checked>
                        <span>Sofort aktivieren</span>
                    </label>
                </div>
                <button type="submit" class="btn-create-subscription">Abo erstellen</button>
            </form>
        </div>
    </div>

    <!-- Modal for editing subscription -->
    <div id="editSubscriptionModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditSubscriptionModal()">&times;</span>
            <h2>Abo bearbeiten</h2>
            
            <div class="modal-product-info">
                <div class="modal-product-image">
                    <img id="editModalProductImage" src="" alt="Product">
                </div>
                <div class="modal-product-details">
                    <h3 id="editModalProductName"></h3>
                    <p class="modal-product-price" id="editModalProductPrice"></p>
                </div>
            </div>
            
            <form method="post" action="" id="editSubscriptionForm">
                <input type="hidden" name="subscription_id" id="editSubscriptionId">
                
                <div class="form-group">
                    <label for="edit_start_date">Startdatum:</label>
                    <input type="date" name="start_date" id="edit_start_date" required>
                </div>

                <div class="form-group">
                    <label for="edit_frequency">Frequenz:</label>
                    <select name="frequency" id="edit_frequency" required>
                        <option value="">Bitte wählen...</option>
                        <option value="täglich">Täglich</option>
                        <option value="wöchentlich">Wöchentlich</option>
                        <option value="alle 2 Wochen">Alle 2 Wochen</option>
                        <option value="monatlich">Monatlich</option>
                        <option value="alle 2 Monate">Alle 2 Monate</option>
                        <option value="vierteljährlich">Vierteljährlich</option>
                        <option value="halbjährlich">Halbjährlich</option>
                        <option value="jährlich">Jährlich</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="activate" id="edit_activate">
                        <span>Abo aktivieren</span>
                    </label>
                </div>
                <button type="submit" class="btn-create-subscription">Abo aktualisieren</button>
            </form>
        </div>
    </div>

    <script>
        function loadProductPreview(event) {
            event.preventDefault();
            
            const url = document.getElementById('productUrl').value;
            
            // Hide form and show loading spinner
            document.getElementById('previewProductForm').style.display = 'none';
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('productPreview').style.display = 'none';
            
            // Fetch product data
            fetch('/preview-product', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ url: url })
            })
            .then(response => response.json())
            .then(data => {
                // Hide loading spinner
                document.getElementById('loadingSpinner').style.display = 'none';
                
                if (data.success) {
                    // Populate preview
                    document.getElementById('previewImg').src = data.image_url || '';
                    document.getElementById('previewTitle').textContent = data.title || 'Unknown Product';
                    document.getElementById('previewPrice').textContent = data.price ? `CHF ${data.price}` : 'Preis nicht verfügbar';
                    document.getElementById('previewUrl').value = url;
                    document.getElementById('previewImageUrl').value = data.image_url || '';
                    document.getElementById('previewPriceValue').value = data.price || '';
                    
                    // Show preview
                    document.getElementById('productPreview').style.display = 'block';
                } else {
                    alert('Fehler beim Laden der Produktdaten: ' + (data.error || 'Unbekannter Fehler'));
                    document.getElementById('previewProductForm').style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Fehler beim Laden der Produktdaten');
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('previewProductForm').style.display = 'block';
            });
        }

        function confirmAddProduct() {
            const url = document.getElementById('previewUrl').value;
            const title = document.getElementById('previewTitle').textContent;
            const imageUrl = document.getElementById('previewImageUrl').value;
            const price = document.getElementById('previewPriceValue').value;
            
            // Create a form and submit
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/add-product';
            
            const urlInput = document.createElement('input');
            urlInput.type = 'hidden';
            urlInput.name = 'url';
            urlInput.value = url;
            form.appendChild(urlInput);
            
            const titleInput = document.createElement('input');
            titleInput.type = 'hidden';
            titleInput.name = 'title';
            titleInput.value = title;
            form.appendChild(titleInput);
            
            const imageInput = document.createElement('input');
            imageInput.type = 'hidden';
            imageInput.name = 'image_url';
            imageInput.value = imageUrl;
            form.appendChild(imageInput);
            
            const priceInput = document.createElement('input');
            priceInput.type = 'hidden';
            priceInput.name = 'price';
            priceInput.value = price;
            form.appendChild(priceInput);
            
            document.body.appendChild(form);
            form.submit();
        }

        function discardPreview() {
            // Reset form and hide preview
            document.getElementById('productUrl').value = '';
            document.getElementById('productPreview').style.display = 'none';
            document.getElementById('previewProductForm').style.display = 'block';
        }

        function deleteProduct(id) {
            if (confirm('Möchten Sie dieses Produkt wirklich löschen?')) {
                fetch(`/delete/${id}`, {
                    method: 'DELETE',
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    }
                });
            }
        }

        function deleteSubscription(id) {
            if (confirm('Möchten Sie dieses Abo wirklich löschen?')) {
                fetch(`/delete-subscription/${id}`, {
                    method: 'DELETE',
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    }
                });
            }
        }

        function addToCart(subscriptionId) {
            if (confirm('Dieses Produkt zum Warenkorb hinzufügen?')) {
                // Show loading indicator
                const button = event.target.closest('button');
                const originalText = button.innerHTML;
                button.innerHTML = '<span class="btn-text">Wird hinzugefügt...</span>';
                button.disabled = true;
                
                fetch(`/add-to-cart/${subscriptionId}`, {
                    method: 'POST',
                })
                .then(response => response.json())
                .then(data => {
                    button.disabled = false;
                    button.innerHTML = originalText;
                    
                    if (data.success) {
                        alert(data.message + '\n\nWarenkorb öffnen?') && window.open(data.cart_url, '_blank');
                    } else {
                        alert('Fehler: ' + data.message);
                    }
                })
                .catch(error => {
                    button.disabled = false;
                    button.innerHTML = originalText;
                    alert('Fehler beim Hinzufügen zum Warenkorb: ' + error);
                });
            }
        }

        function addAllActiveToCart() {
            if (confirm('Alle aktiven Abos zum Warenkorb hinzufügen?')) {
                fetch('/add-all-active-to-cart', {
                    method: 'POST',
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message + '\n\nWarenkorb öffnen?') && window.open(data.cart_url, '_blank');
                    } else {
                        alert('Fehler: ' + data.message);
                    }
                })
                .catch(error => {
                    alert('Fehler: ' + error);
                });
            }
        }

        function showSubscriptionModal(productId, productName, productImage, productPrice) {
            document.getElementById('subscriptionModal').style.display = 'block';
            document.getElementById('modalProductId').value = productId;
            document.getElementById('modalProductName').textContent = productName;
            
            // Set default start date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('start_date').value = today;
            
            // Set product image
            const imgElement = document.getElementById('modalProductImage');
            if (productImage && productImage !== '') {
                imgElement.src = productImage;
                imgElement.parentElement.style.display = 'flex';
            } else {
                imgElement.parentElement.style.display = 'none';
            }
            
            // Set product price
            const priceElement = document.getElementById('modalProductPrice');
            if (productPrice && productPrice !== '') {
                priceElement.textContent = 'CHF ' + productPrice;
                priceElement.style.display = 'block';
            } else {
                priceElement.style.display = 'none';
            }
        }

        function closeSubscriptionModal() {
            document.getElementById('subscriptionModal').style.display = 'none';
            document.getElementById('subscriptionForm').reset();
        }

        async function editSubscription(subscriptionId) {
            try {
                // Fetch subscription data
                const response = await fetch(`/get-subscription/${subscriptionId}`);
                
                if (!response.ok) {
                    throw new Error('Fehler beim Laden der Abo-Daten');
                }
                
                const data = await response.json();
                
                // Populate the edit modal with subscription data
                document.getElementById('editSubscriptionId').value = data.id;
                document.getElementById('editModalProductName').textContent = data.product_name;
                document.getElementById('edit_start_date').value = data.start_date;
                document.getElementById('edit_frequency').value = data.frequency;
                document.getElementById('edit_activate').checked = data.is_active;
                
                // Set product image
                const imgElement = document.getElementById('editModalProductImage');
                if (data.product_image && data.product_image !== '') {
                    imgElement.src = data.product_image;
                    imgElement.parentElement.style.display = 'flex';
                } else {
                    imgElement.parentElement.style.display = 'none';
                }
                
                // Set product price
                const priceElement = document.getElementById('editModalProductPrice');
                if (data.product_price && data.product_price !== '') {
                    priceElement.textContent = 'CHF ' + data.product_price;
                    priceElement.style.display = 'block';
                } else {
                    priceElement.style.display = 'none';
                }
                
                // Set form action
                document.getElementById('editSubscriptionForm').action = `/update-subscription/${subscriptionId}`;
                
                // Show the modal
                document.getElementById('editSubscriptionModal').style.display = 'block';
                
            } catch (error) {
                console.error('Error:', error);
                alert('Fehler beim Laden der Abo-Daten. Bitte versuchen Sie es erneut.');
            }
        }

        function closeEditSubscriptionModal() {
            document.getElementById('editSubscriptionModal').style.display = 'none';
            document.getElementById('editSubscriptionForm').reset();
        }

        async function generateEmailPreview() {
            try {
                // Send the subscription email
                const response = await fetch('/send-subscription-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('✅ ' + result.message);
                } else {
                    alert('❌ ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Fehler beim Senden der E-Mail. Bitte versuchen Sie es erneut.');
            }
        }

        // Filter products
        function filterProducts() {
            const searchValue = document.getElementById('productSearch').value.toLowerCase();
            const filterValue = document.getElementById('productFilter').value;
            const products = document.querySelectorAll('.product-card');
            let visibleCount = 0;

            products.forEach(product => {
                const productName = product.getAttribute('data-product-name');
                const hasSubscription = product.getAttribute('data-has-subscription') === 'true';
                
                // Check search match
                const matchesSearch = productName.includes(searchValue);
                
                // Check filter match
                let matchesFilter = true;
                if (filterValue === 'with-subscription') {
                    matchesFilter = hasSubscription;
                } else if (filterValue === 'without-subscription') {
                    matchesFilter = !hasSubscription;
                }
                
                // Show or hide based on both conditions
                if (matchesSearch && matchesFilter) {
                    product.style.display = 'flex';
                    visibleCount++;
                } else {
                    product.style.display = 'none';
                }
            });

            // Update count
            document.getElementById('productCount').textContent = visibleCount;
        }

        // Filter subscriptions
        function filterSubscriptions() {
            const searchValue = document.getElementById('subscriptionSearch').value.toLowerCase();
            const filterValue = document.getElementById('subscriptionFilter').value;
            const subscriptions = document.querySelectorAll('.subscription-card');
            let visibleCount = 0;

            subscriptions.forEach(subscription => {
                const subscriptionName = subscription.getAttribute('data-subscription-name');
                const isActive = subscription.getAttribute('data-is-active') === 'true';
                
                // Check search match
                const matchesSearch = subscriptionName.includes(searchValue);
                
                // Check filter match
                let matchesFilter = true;
                if (filterValue === 'active') {
                    matchesFilter = isActive;
                } else if (filterValue === 'inactive') {
                    matchesFilter = !isActive;
                }
                
                // Show or hide based on both conditions
                if (matchesSearch && matchesFilter) {
                    subscription.style.display = 'flex';
                    visibleCount++;
                } else {
                    subscription.style.display = 'none';
                }
            });

            // Update count
            document.getElementById('subscriptionCount').textContent = visibleCount;
        }

        // Sort products
        function sortProducts() {
            const sortValue = document.getElementById('productSort').value;
            if (!sortValue) return;

            const productList = document.getElementById('productList');
            const products = Array.from(document.querySelectorAll('.product-card'));

            products.sort((a, b) => {
                const [field, order] = sortValue.split('-');
                let aValue, bValue;

                switch(field) {
                    case 'name':
                        aValue = a.getAttribute('data-product-name');
                        bValue = b.getAttribute('data-product-name');
                        break;
                    case 'price':
                        aValue = parseFloat(a.getAttribute('data-price')) || 0;
                        bValue = parseFloat(b.getAttribute('data-price')) || 0;
                        break;
                    case 'date':
                        aValue = parseFloat(a.getAttribute('data-date')) || 0;
                        bValue = parseFloat(b.getAttribute('data-date')) || 0;
                        break;
                }

                if (order === 'asc') {
                    return aValue > bValue ? 1 : -1;
                } else {
                    return aValue < bValue ? 1 : -1;
                }
            });

            // Re-append in sorted order
            products.forEach(product => productList.appendChild(product));
        }

        // Sort subscriptions
        function sortSubscriptions() {
            const sortValue = document.getElementById('subscriptionSort').value;
            if (!sortValue) return;

            const subscriptionList = document.getElementById('subscriptionList');
            const subscriptions = Array.from(document.querySelectorAll('.subscription-card'));

            subscriptions.sort((a, b) => {
                const [field, order] = sortValue.split('-');
                let aValue, bValue;

                switch(field) {
                    case 'name':
                        aValue = a.getAttribute('data-subscription-name');
                        bValue = b.getAttribute('data-subscription-name');
                        break;
                    case 'price':
                        aValue = parseFloat(a.getAttribute('data-price')) || 0;
                        bValue = parseFloat(b.getAttribute('data-price')) || 0;
                        break;
                    case 'next':
                        // Handle next-buy date sorting (format: dd.mm.yyyy)
                        const aDate = a.getAttribute('data-next-buy');
                        const bDate = b.getAttribute('data-next-buy');
                        
                        // Convert dd.mm.yyyy to comparable format
                        const parseDate = (dateStr) => {
                            if (!dateStr) return new Date(9999, 0, 1); // Far future for empty dates
                            const parts = dateStr.split('.');
                            if (parts.length === 3) {
                                return new Date(parts[2], parts[1] - 1, parts[0]);
                            }
                            return new Date(9999, 0, 1);
                        };
                        
                        aValue = parseDate(aDate);
                        bValue = parseDate(bDate);
                        break;
                    case 'date':
                        aValue = parseFloat(a.getAttribute('data-date')) || 0;
                        bValue = parseFloat(b.getAttribute('data-date')) || 0;
                        break;
                }

                if (order === 'asc' || order === 'buy') {
                    return aValue > bValue ? 1 : -1;
                } else {
                    return aValue < bValue ? 1 : -1;
                }
            });

            // Re-append in sorted order
            subscriptions.forEach(subscription => subscriptionList.appendChild(subscription));
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('subscriptionModal');
            if (event.target == modal) {
                closeSubscriptionModal();
            }
        }
    </script>
</body>
</html>
